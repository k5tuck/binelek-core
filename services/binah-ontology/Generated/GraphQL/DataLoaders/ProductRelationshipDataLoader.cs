// <auto-generated />
// Generated from SupplyChainOntology vv1.0.0

using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;
using GreenDonut;
using HotChocolate.DataLoader;
using Acme.SupplyChain.Repositories;

namespace Acme.SupplyChain.GraphQL.DataLoaders
{
    /// <summary>
    /// DataLoader for batch loading relationships for Product entities
    /// Prevents N+1 query problems when resolving relationship metadata
    /// </summary>
    public class ProductRelationshipDataLoader : BatchDataLoader<string, IEnumerable<string>>
    {
        private readonly IProductRepository _repository;

        public ProductRelationshipDataLoader(
            IProductRepository repository,
            IBatchScheduler batchScheduler,
            DataLoaderOptions? options = null)
            : base(batchScheduler, options)
        {
            _repository = repository ?? throw new ArgumentNullException(nameof(repository));
        }

        protected override async Task<IReadOnlyDictionary<string, IEnumerable<string>>> LoadBatchAsync(
            IReadOnlyList<string> keys,
            CancellationToken cancellationToken)
        {
            // Batch fetch all relationships for the given Product IDs
            var relationships = await _repository.GetRelationshipsAsync(keys, cancellationToken);

            // Group relationships by source entity ID
            return relationships
                .GroupBy(r => r.SourceId)
                .ToDictionary(
                    g => g.Key,
                    g => g.Select(r => r.Type).AsEnumerable());
        }
    }
}
