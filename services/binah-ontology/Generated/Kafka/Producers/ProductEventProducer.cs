// <auto-generated />
// Generated from SupplyChainOntology vv1.0.0

using System;
using System.Text;
using System.Threading.Tasks;
using Confluent.Kafka;
using Microsoft.Extensions.Logging;
using Acme.SupplyChain.Kafka.Events;

namespace Acme.SupplyChain.Kafka.Producers
{
    /// <summary>
    /// Typed Kafka producer for Product events
    /// </summary>
    public class ProductEventProducer : IProductEventProducer
    {
        private readonly IProducer<string, ProductCreatedEvent> _createdProducer;
        private readonly IProducer<string, ProductUpdatedEvent> _updatedProducer;
        private readonly IProducer<string, ProductDeletedEvent> _deletedProducer;
        private readonly ILogger<ProductEventProducer> _logger;

        public ProductEventProducer(
            IProducer<string, ProductCreatedEvent> createdProducer,
            IProducer<string, ProductUpdatedEvent> updatedProducer,
            IProducer<string, ProductDeletedEvent> deletedProducer,
            ILogger<ProductEventProducer> logger)
        {
            _createdProducer = createdProducer ?? throw new ArgumentNullException(nameof(createdProducer));
            _updatedProducer = updatedProducer ?? throw new ArgumentNullException(nameof(updatedProducer));
            _deletedProducer = deletedProducer ?? throw new ArgumentNullException(nameof(deletedProducer));
            _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        }

        public async Task PublishCreatedAsync(ProductCreatedEvent evt)
        {
            try
            {
                var result = await _createdProducer.ProduceAsync(
                    KafkaTopics.OntologyEntityCreated,
                    new Message<string, ProductCreatedEvent>
                    {
                        Key = evt.EntityId,
                        Value = evt,
                        Headers = new Headers
                        {
                            { "entity-type", Encoding.UTF8.GetBytes("Product") },
                            { "event-type", Encoding.UTF8.GetBytes("Created") },
                            { "tenant-id", Encoding.UTF8.GetBytes(evt.TenantId) }
                        }
                    }
                );

                _logger.LogInformation("ProductCreated event published to {Topic} at offset {Offset}",
                    result.Topic, result.Offset);
            }
            catch (ProduceException<string, ProductCreatedEvent> ex)
            {
                _logger.LogError(ex, "Failed to publish ProductCreated event");
                throw;
            }
        }

        public async Task PublishUpdatedAsync(ProductUpdatedEvent evt)
        {
            try
            {
                var result = await _updatedProducer.ProduceAsync(
                    KafkaTopics.OntologyEntityUpdated,
                    new Message<string, ProductUpdatedEvent>
                    {
                        Key = evt.EntityId,
                        Value = evt,
                        Headers = new Headers
                        {
                            { "entity-type", Encoding.UTF8.GetBytes("Product") },
                            { "event-type", Encoding.UTF8.GetBytes("Updated") },
                            { "tenant-id", Encoding.UTF8.GetBytes(evt.TenantId) }
                        }
                    }
                );

                _logger.LogInformation("ProductUpdated event published to {Topic} at offset {Offset}",
                    result.Topic, result.Offset);
            }
            catch (ProduceException<string, ProductUpdatedEvent> ex)
            {
                _logger.LogError(ex, "Failed to publish ProductUpdated event");
                throw;
            }
        }

        public async Task PublishDeletedAsync(ProductDeletedEvent evt)
        {
            try
            {
                var result = await _deletedProducer.ProduceAsync(
                    KafkaTopics.OntologyEntityDeleted,
                    new Message<string, ProductDeletedEvent>
                    {
                        Key = evt.EntityId,
                        Value = evt,
                        Headers = new Headers
                        {
                            { "entity-type", Encoding.UTF8.GetBytes("Product") },
                            { "event-type", Encoding.UTF8.GetBytes("Deleted") },
                            { "tenant-id", Encoding.UTF8.GetBytes(evt.TenantId) }
                        }
                    }
                );

                _logger.LogInformation("ProductDeleted event published to {Topic} at offset {Offset}",
                    result.Topic, result.Offset);
            }
            catch (ProduceException<string, ProductDeletedEvent> ex)
            {
                _logger.LogError(ex, "Failed to publish ProductDeleted event");
                throw;
            }
        }
    }
}
