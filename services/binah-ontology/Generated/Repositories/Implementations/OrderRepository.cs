// <auto-generated />
// Generated from SupplyChainOntology vv1.0.0

using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.Extensions.Logging;
using Neo4j.Driver;
using Acme.SupplyChain.Entities;
using Acme.SupplyChain.Repositories.Interfaces;
using Acme.SupplyChain.Repositories.Models;

namespace Acme.SupplyChain.Repositories.Implementations
{
    /// <summary>
    /// Neo4j repository implementation for Order entity
    /// </summary>
    public class OrderRepository : IOrderRepository
    {
        private readonly IDriver _driver;
        private readonly ILogger<OrderRepository> _logger;

        public OrderRepository(IDriver driver, ILogger<OrderRepository> logger)
        {
            _driver = driver ?? throw new ArgumentNullException(nameof(driver));
            _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        }

        /// <inheritdoc/>
        public async Task<Order> CreateAsync(Order entity, string tenantId)
        {
            if (entity == null) throw new ArgumentNullException(nameof(entity));
            if (string.IsNullOrWhiteSpace(tenantId)) throw new ArgumentException("Tenant ID cannot be null or empty", nameof(tenantId));

            const string cypher = @"
                MERGE (e:Order {
                    OrderId: $orderId,
                    TenantId: $tenantId
                })
                SET e.OrderNumber = $orderNumber,
                    e.CustomerId = $customerId,
                    e.TotalAmount = $totalAmount,
                    e.Status = $status,
                    e.OrderDate = $orderDate
                    ,
                    e.CreatedAt = datetime(),
                    e.UpdatedAt = datetime(),
                    e.IsDeleted = false
                RETURN e";

            await using var session = _driver.AsyncSession();
            try
            {
                var result = await session.ExecuteWriteAsync(async tx =>
                {
                    var cursor = await tx.RunAsync(cypher, new
                    {
                        orderId = entity.OrderId,
                        tenantId = tenantId
                        , orderNumber = entity.OrderNumber
                        , customerId = entity.CustomerId
                        , totalAmount = entity.TotalAmount
                        , status = entity.Status
                        , orderDate = entity.OrderDate
                    });
                    return await cursor.SingleAsync();
                });

                return MapToOrder(result["e"].As<INode>());
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating Order in Neo4j");
                throw;
            }
        }

        /// <inheritdoc/>
        public async Task<Order?> GetByIdAsync(Guid id, string tenantId)
        {
            if (string.IsNullOrWhiteSpace(tenantId)) throw new ArgumentException("Tenant ID cannot be null or empty", nameof(tenantId));

            const string cypher = @"
                MATCH (e:Order {OrderId: $id, TenantId: $tenantId, IsDeleted: false})
                RETURN e";

            await using var session = _driver.AsyncSession();
            try
            {
                var result = await session.ExecuteReadAsync(async tx =>
                {
                    var cursor = await tx.RunAsync(cypher, new { id, tenantId });
                    return await cursor.SingleOrDefaultAsync();
                });

                if (result == null) return null;
                return MapToOrder(result["e"].As<INode>());
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error retrieving Order {Id} from Neo4j", id);
                throw;
            }
        }

        /// <inheritdoc/>
        public async Task<IEnumerable<Order>> GetAllAsync(string tenantId, int skip = 0, int limit = 100)
        {
            if (string.IsNullOrWhiteSpace(tenantId)) throw new ArgumentException("Tenant ID cannot be null or empty", nameof(tenantId));

            const string cypher = @"
                MATCH (e:Order {TenantId: $tenantId, IsDeleted: false})
                RETURN e
                ORDER BY e.CreatedAt DESC
                SKIP $skip
                LIMIT $limit";

            await using var session = _driver.AsyncSession();
            try
            {
                var results = await session.ExecuteReadAsync(async tx =>
                {
                    var cursor = await tx.RunAsync(cypher, new { tenantId, skip, limit });
                    return await cursor.ToListAsync();
                });

                return results.Select(record => MapToOrder(record["e"].As<INode>())).ToList();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error retrieving Order entities from Neo4j");
                throw;
            }
        }

        /// <inheritdoc/>
        public async Task<Order> UpdateAsync(Order entity, string tenantId)
        {
            if (entity == null) throw new ArgumentNullException(nameof(entity));
            if (string.IsNullOrWhiteSpace(tenantId)) throw new ArgumentException("Tenant ID cannot be null or empty", nameof(tenantId));

            const string cypher = @"
                MATCH (e:Order {OrderId: $orderId, TenantId: $tenantId, IsDeleted: false})
                SET e.OrderNumber = $orderNumber,
                    e.CustomerId = $customerId,
                    e.TotalAmount = $totalAmount,
                    e.Status = $status,
                    e.OrderDate = $orderDate,
                    e.UpdatedAt = datetime()
                RETURN e";

            await using var session = _driver.AsyncSession();
            try
            {
                var result = await session.ExecuteWriteAsync(async tx =>
                {
                    var cursor = await tx.RunAsync(cypher, new
                    {
                        orderId = entity.OrderId,
                        tenantId = tenantId
                        , orderNumber = entity.OrderNumber
                        , customerId = entity.CustomerId
                        , totalAmount = entity.TotalAmount
                        , status = entity.Status
                        , orderDate = entity.OrderDate
                    });
                    var record = await cursor.SingleOrDefaultAsync();
                    if (record == null) throw new InvalidOperationException($"{entity.Name} not found");
                    return record;
                });

                return MapToOrder(result["e"].As<INode>());
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating Order in Neo4j");
                throw;
            }
        }

        /// <inheritdoc/>
        public async Task DeleteAsync(Guid id, string tenantId)
        {
            if (string.IsNullOrWhiteSpace(tenantId)) throw new ArgumentException("Tenant ID cannot be null or empty", nameof(tenantId));

            const string cypher = @"
                MATCH (e:Order {OrderId: $id, TenantId: $tenantId})
                SET e.IsDeleted = true, e.UpdatedAt = datetime()
                RETURN e";

            await using var session = _driver.AsyncSession();
            try
            {
                await session.ExecuteWriteAsync(async tx =>
                {
                    var cursor = await tx.RunAsync(cypher, new { id, tenantId });
                    var result = await cursor.SingleOrDefaultAsync();
                    if (result == null) throw new InvalidOperationException($"{entity.Name} not found");
                    return result;
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting Order {Id} from Neo4j", id);
                throw;
            }
        }

        /// <inheritdoc/>
        public async Task<OrderWithRelationships?> GetWithRelationshipsAsync(Guid id, string tenantId)
        {
            if (string.IsNullOrWhiteSpace(tenantId)) throw new ArgumentException("Tenant ID cannot be null or empty", nameof(tenantId));

            const string cypher = @"
                MATCH (e:Order {OrderId: $id, TenantId: $tenantId, IsDeleted: false})
                OPTIONAL MATCH (e)-[r]->(related)
                WHERE related.TenantId = $tenantId AND related.IsDeleted = false
                RETURN e, collect({{type: type(r), node: related}}) AS relationships";

            await using var session = _driver.AsyncSession();
            try
            {
                var result = await session.ExecuteReadAsync(async tx =>
                {
                    var cursor = await tx.RunAsync(cypher, new { id, tenantId });
                    return await cursor.SingleOrDefaultAsync();
                });

                if (result == null) return null;

                var withRelationships = new OrderWithRelationships
                {
                    Entity = MapToOrder(result["e"].As<INode>()),
                    RelatedEntities = new Dictionary<string, List<object>>()
                };

                var relationshipsData = result["relationships"].As<List<Dictionary<string, object>>>();
                foreach (var relData in relationshipsData)
                {
                    if (relData["node"] != null)
                    {
                        var relType = relData["type"].ToString();
                        var node = relData["node"] as INode;
                        if (node != null)
                        {
                            if (!withRelationships.RelatedEntities.ContainsKey(relType))
                            {
                                withRelationships.RelatedEntities[relType] = new List<object>();
                            }
                            withRelationships.RelatedEntities[relType].Add(node.Properties);
                        }
                    }
                }

                return withRelationships;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error retrieving Order {Id} with relationships from Neo4j", id);
                throw;
            }
        }

        private Order MapToOrder(INode node)
        {
            return new Order
            {
                OrderId = node.Properties["OrderId"].As<Guid>(),
                OrderNumber = node.Properties.ContainsKey("OrderNumber") ? node.Properties["OrderNumber"].As<string>() : string.Empty,
                CustomerId = node.Properties["CustomerId"].As<Guid>(),
                TotalAmount = node.Properties["TotalAmount"].As<decimal>(),
                Status = node.Properties.ContainsKey("Status") ? node.Properties["Status"].As<string>() : string.Empty,
                OrderDate = node.Properties["OrderDate"].As<DateTime>(),
                CreatedAt = node.Properties.ContainsKey("CreatedAt") ? node.Properties["CreatedAt"].As<DateTime>() : DateTime.UtcNow,
                UpdatedAt = node.Properties.ContainsKey("UpdatedAt") ? node.Properties["UpdatedAt"].As<DateTime>() : DateTime.UtcNow,
                IsDeleted = node.Properties.ContainsKey("IsDeleted") && node.Properties["IsDeleted"].As<bool>()
            };
        }
    }
}
