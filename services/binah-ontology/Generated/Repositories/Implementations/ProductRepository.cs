// <auto-generated />
// Generated from SupplyChainOntology vv1.0.0

using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.Extensions.Logging;
using Neo4j.Driver;
using Acme.SupplyChain.Entities;
using Acme.SupplyChain.Repositories.Interfaces;
using Acme.SupplyChain.Repositories.Models;

namespace Acme.SupplyChain.Repositories.Implementations
{
    /// <summary>
    /// Neo4j repository implementation for Product entity
    /// </summary>
    public class ProductRepository : IProductRepository
    {
        private readonly IDriver _driver;
        private readonly ILogger<ProductRepository> _logger;

        public ProductRepository(IDriver driver, ILogger<ProductRepository> logger)
        {
            _driver = driver ?? throw new ArgumentNullException(nameof(driver));
            _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        }

        /// <inheritdoc/>
        public async Task<Product> CreateAsync(Product entity, string tenantId)
        {
            if (entity == null) throw new ArgumentNullException(nameof(entity));
            if (string.IsNullOrWhiteSpace(tenantId)) throw new ArgumentException("Tenant ID cannot be null or empty", nameof(tenantId));

            const string cypher = @"
                MERGE (e:Product {
                    ProductId: $productId,
                    TenantId: $tenantId
                })
                SET e.SKU = $sKU,
                    e.Name = $name,
                    e.Description = $description,
                    e.UnitPrice = $unitPrice,
                    e.StockQuantity = $stockQuantity
                    ,
                    e.CreatedAt = datetime(),
                    e.UpdatedAt = datetime(),
                    e.IsDeleted = false
                RETURN e";

            await using var session = _driver.AsyncSession();
            try
            {
                var result = await session.ExecuteWriteAsync(async tx =>
                {
                    var cursor = await tx.RunAsync(cypher, new
                    {
                        productId = entity.ProductId,
                        tenantId = tenantId
                        , sKU = entity.SKU
                        , name = entity.Name
                        , description = entity.Description
                        , unitPrice = entity.UnitPrice
                        , stockQuantity = entity.StockQuantity
                    });
                    return await cursor.SingleAsync();
                });

                return MapToProduct(result["e"].As<INode>());
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating Product in Neo4j");
                throw;
            }
        }

        /// <inheritdoc/>
        public async Task<Product?> GetByIdAsync(Guid id, string tenantId)
        {
            if (string.IsNullOrWhiteSpace(tenantId)) throw new ArgumentException("Tenant ID cannot be null or empty", nameof(tenantId));

            const string cypher = @"
                MATCH (e:Product {ProductId: $id, TenantId: $tenantId, IsDeleted: false})
                RETURN e";

            await using var session = _driver.AsyncSession();
            try
            {
                var result = await session.ExecuteReadAsync(async tx =>
                {
                    var cursor = await tx.RunAsync(cypher, new { id, tenantId });
                    return await cursor.SingleOrDefaultAsync();
                });

                if (result == null) return null;
                return MapToProduct(result["e"].As<INode>());
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error retrieving Product {Id} from Neo4j", id);
                throw;
            }
        }

        /// <inheritdoc/>
        public async Task<IEnumerable<Product>> GetAllAsync(string tenantId, int skip = 0, int limit = 100)
        {
            if (string.IsNullOrWhiteSpace(tenantId)) throw new ArgumentException("Tenant ID cannot be null or empty", nameof(tenantId));

            const string cypher = @"
                MATCH (e:Product {TenantId: $tenantId, IsDeleted: false})
                RETURN e
                ORDER BY e.CreatedAt DESC
                SKIP $skip
                LIMIT $limit";

            await using var session = _driver.AsyncSession();
            try
            {
                var results = await session.ExecuteReadAsync(async tx =>
                {
                    var cursor = await tx.RunAsync(cypher, new { tenantId, skip, limit });
                    return await cursor.ToListAsync();
                });

                return results.Select(record => MapToProduct(record["e"].As<INode>())).ToList();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error retrieving Product entities from Neo4j");
                throw;
            }
        }

        /// <inheritdoc/>
        public async Task<Product> UpdateAsync(Product entity, string tenantId)
        {
            if (entity == null) throw new ArgumentNullException(nameof(entity));
            if (string.IsNullOrWhiteSpace(tenantId)) throw new ArgumentException("Tenant ID cannot be null or empty", nameof(tenantId));

            const string cypher = @"
                MATCH (e:Product {ProductId: $productId, TenantId: $tenantId, IsDeleted: false})
                SET e.SKU = $sKU,
                    e.Name = $name,
                    e.Description = $description,
                    e.UnitPrice = $unitPrice,
                    e.StockQuantity = $stockQuantity,
                    e.UpdatedAt = datetime()
                RETURN e";

            await using var session = _driver.AsyncSession();
            try
            {
                var result = await session.ExecuteWriteAsync(async tx =>
                {
                    var cursor = await tx.RunAsync(cypher, new
                    {
                        productId = entity.ProductId,
                        tenantId = tenantId
                        , sKU = entity.SKU
                        , name = entity.Name
                        , description = entity.Description
                        , unitPrice = entity.UnitPrice
                        , stockQuantity = entity.StockQuantity
                    });
                    var record = await cursor.SingleOrDefaultAsync();
                    if (record == null) throw new InvalidOperationException($"{entity.Name} not found");
                    return record;
                });

                return MapToProduct(result["e"].As<INode>());
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating Product in Neo4j");
                throw;
            }
        }

        /// <inheritdoc/>
        public async Task DeleteAsync(Guid id, string tenantId)
        {
            if (string.IsNullOrWhiteSpace(tenantId)) throw new ArgumentException("Tenant ID cannot be null or empty", nameof(tenantId));

            const string cypher = @"
                MATCH (e:Product {ProductId: $id, TenantId: $tenantId})
                SET e.IsDeleted = true, e.UpdatedAt = datetime()
                RETURN e";

            await using var session = _driver.AsyncSession();
            try
            {
                await session.ExecuteWriteAsync(async tx =>
                {
                    var cursor = await tx.RunAsync(cypher, new { id, tenantId });
                    var result = await cursor.SingleOrDefaultAsync();
                    if (result == null) throw new InvalidOperationException($"{entity.Name} not found");
                    return result;
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting Product {Id} from Neo4j", id);
                throw;
            }
        }

        /// <inheritdoc/>
        public async Task<ProductWithRelationships?> GetWithRelationshipsAsync(Guid id, string tenantId)
        {
            if (string.IsNullOrWhiteSpace(tenantId)) throw new ArgumentException("Tenant ID cannot be null or empty", nameof(tenantId));

            const string cypher = @"
                MATCH (e:Product {ProductId: $id, TenantId: $tenantId, IsDeleted: false})
                OPTIONAL MATCH (e)-[r]->(related)
                WHERE related.TenantId = $tenantId AND related.IsDeleted = false
                RETURN e, collect({{type: type(r), node: related}}) AS relationships";

            await using var session = _driver.AsyncSession();
            try
            {
                var result = await session.ExecuteReadAsync(async tx =>
                {
                    var cursor = await tx.RunAsync(cypher, new { id, tenantId });
                    return await cursor.SingleOrDefaultAsync();
                });

                if (result == null) return null;

                var withRelationships = new ProductWithRelationships
                {
                    Entity = MapToProduct(result["e"].As<INode>()),
                    RelatedEntities = new Dictionary<string, List<object>>()
                };

                var relationshipsData = result["relationships"].As<List<Dictionary<string, object>>>();
                foreach (var relData in relationshipsData)
                {
                    if (relData["node"] != null)
                    {
                        var relType = relData["type"].ToString();
                        var node = relData["node"] as INode;
                        if (node != null)
                        {
                            if (!withRelationships.RelatedEntities.ContainsKey(relType))
                            {
                                withRelationships.RelatedEntities[relType] = new List<object>();
                            }
                            withRelationships.RelatedEntities[relType].Add(node.Properties);
                        }
                    }
                }

                return withRelationships;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error retrieving Product {Id} with relationships from Neo4j", id);
                throw;
            }
        }

        private Product MapToProduct(INode node)
        {
            return new Product
            {
                ProductId = node.Properties["ProductId"].As<Guid>(),
                SKU = node.Properties.ContainsKey("SKU") ? node.Properties["SKU"].As<string>() : string.Empty,
                Name = node.Properties.ContainsKey("Name") ? node.Properties["Name"].As<string>() : string.Empty,
                Description = node.Properties.ContainsKey("Description") ? node.Properties["Description"].As<string>() : string.Empty,
                UnitPrice = node.Properties["UnitPrice"].As<decimal>(),
                StockQuantity = node.Properties["StockQuantity"].As<int>(),
                CreatedAt = node.Properties.ContainsKey("CreatedAt") ? node.Properties["CreatedAt"].As<DateTime>() : DateTime.UtcNow,
                UpdatedAt = node.Properties.ContainsKey("UpdatedAt") ? node.Properties["UpdatedAt"].As<DateTime>() : DateTime.UtcNow,
                IsDeleted = node.Properties.ContainsKey("IsDeleted") && node.Properties["IsDeleted"].As<bool>()
            };
        }
    }
}
